W = rbinom(n=n_target, size=1, prob=.5))
}
#define random slopes for moderators in target sample
eps_inter_target <- matrix(nrow=n_target, ncol=length(covars_rand))
colnames(eps_inter_target) <- paste0("eps_",covars_rand)
for (i in 1:length(covars_rand)) {
eps_inter_target[,i] <- rnorm(n=n_target, mean=0, sd=eps_study_inter[i])
}
#add error terms to target sample
target_dat <- target_dat %>%
mutate(eps_m = rnorm(n=n_target, mean=0, sd=eps_study_m),
eps_tau = rnorm(n=n_target, mean=0, sd=eps_study_tau)) %>%
bind_cols(eps_inter_target)
#standardize variables
#add m and tau
train_dat <- train_dat %>%
mutate(age = (age - mean(age))/sd(age),
madrs = (madrs - mean(madrs))/sd(madrs),
weight = (weight - mean(weight))/sd(weight))
target_dat <- target_dat %>%
mutate(age = (age - mean(age))/sd(age),
madrs = (madrs - mean(madrs))/sd(madrs),
weight = (weight - mean(weight))/sd(weight))
if (length(covars_fix) == 1 & length(covars_rand) == 1) {
train_dat <- train_dat %>%
mutate(m = (-17.40 + eps_m) - 0.13*age - 2.05*madrs - 0.11*sex,
tau = (2.505 + eps_tau) + (0.82 + eps_age)*age)
target_dat <- target_dat %>%
mutate(m = (-17.40 + eps_m) - 0.13*age - 2.05*madrs - 0.11*sex,
tau = (2.505 + eps_tau) + (0.82 + eps_age)*age)
} else if (covars_fix == c("age", "madrs") & covars_rand == c("age", "madrs")) {
## FIGURE THIS OUT
} else if (covars_fix == c("age", "sex") & covars_rand == c("age", "sex")) {
## FIGURE THIS OUT
} else if (covars_fix == c("age", "sex") & covars_rand == c("age")) {
## FIGURE THIS OUT
}
#outcome Y
train_dat <- train_dat %>%
mutate(Y = m + W*tau + eps,
S = factor(S)) %>%
dplyr::select(S, W, sex, smstat, weight, age, madrs, Y, tau)
target_dat <- target_dat %>%
mutate(Y = m + W*tau + eps) %>%
dplyr::select(W, sex, smstat, weight, age, madrs, Y, tau)
return(list(train_dat=train_dat, target_dat=target_dat))
}
## Simulate training and target (OOS) data
sim_dat <- gen_mdd(K, n_mean, n_sd, n_target, covars_fix, covars_rand,
eps_study_m, eps_study_tau, eps_study_inter,
distribution, target_dist)
train_dat <- sim_dat[["train_dat"]]
target_dat <- sim_dat[["target_dat"]]
head(train_dat)
?glm
ranef(mod)
## Fit mixed effects models
#correct
formula <- as.formula(paste0("Y ~ madrs + sex + age + W + ",
paste("W", covars_fix, sep=":", collapse=" + "),
" + (W + ",
paste("W", covars_rand, sep=":", collapse=" + "),
" | S)"))
mod <- lmer(formula, data=train_dat,
control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=10000)))
sum <- summary(mod)
ranef(mod)
ranef(mod, cond.var=T)
ranef(mod, condVar=T)
library(tidyverse)
library(lme4)
library(rsample)
library(multcomp)
library(MASS)
source("R/MDD_Generation_OOSEst.R")
source("R/MA_OOSEst.R")
# set up parameters
K <- 10
n_mean <- 500
n_sd <- 0
n_target <- 100
settings <- expand.grid(eps_study_m = c(0.05, 1),
eps_combo = c("0.05 0", "0.5 0.05", "0.5 0.5",
"1 0.05", "1 0.5", "1 1"),
distribution = c("same", "varying_madrs", "halfdiff_madrsage", "separate_age"),
target_dist = c("same", "different"),
iteration = c(1:100)) %>%
separate(eps_combo, into=c("eps_study_tau", "eps_study_age"), sep=" ") %>%
mutate(eps_study_tau = as.numeric(eps_study_tau),
eps_study_age = as.numeric(eps_study_age))
head(settings)
covars <- list(list(covars_fix="age", covars_rand="age"),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs")),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex")),
list(covars_fix=c("age", "sex"), covars_rand=c("age")))
covars
head(settings)
c(1:4)
covars <- list(list(covars_fix="age", covars_rand="age", eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age", eps_study_inter=0.5),
list(covars_fix="age", covars_rand="age", eps_study_inter=1),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"), eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"), eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"), eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"), eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age"), eps_study_inter=0.05),
list(covars_fix=c("age", "sex"), covars_rand=c("age"), eps_study_inter=0.5))
covars
c(1:length(covars))
settings <- expand.grid(moderators = c(1:length(covars)),
eps_study_m = c(0.05, 1), eps_study_tau = c(0.05, 0.5, 1),
distribution = c("same", "varying_madrs", "halfdiff_madrsage", "separate_age"),
target_dist = c("same", "different"),
iteration = c(1:100))
head(settings)
sum(settings[settings$iteration==1])
sum(settings[settings$iteration==1,])
nrow(settings[settings$iteration==1,])
View(settings)
i=1
moderators <- settings$moderators[i]
moderators
covars_fix <- covars[[moderators]]$covars_fix
covars_rand <- covars[[moderators]]$covars_rand
eps_study_inter <- covars[[moderators]]$eps_study_inter
covars_fix
covars_rand
eps_study_inter
head(settings)
paste(covars_fix, covars_rand)
c <- c("a","b")
d <- c("b","c")
paste(a,b)
paste(c,d)
paste(c,d, sep="_")
moderators <- settings$moderators[i]
covars_fix <- covars[[moderators]]$covars_fix
covars_rand <- covars[[moderators]]$covars_rand
eps_study_inter <- covars[[moderators]]$eps_study_inter
eps_study_m <- settings$eps_study_m[i]
eps_study_tau <- settings$eps_study_tau[i]
distribution <- settings$distribution[i]
target_dist <- settings$target_dist[i]
iteration <- settings$iteration[i]
seed <- i
paste(paste("results",seed,iteration,K,n_mean,n_sd,n_target,covars_fix,covars_rand,
eps_study_m,eps_study_tau,eps_study_inter,distribution,target_dist,sep = "_"),
".Rdata",sep="")
paste(paste("results",seed,iteration,K,n_mean,n_sd,n_target,c,d,
eps_study_m,eps_study_tau,eps_study_inter,distribution,target_dist,sep = "_"),
".Rdata",sep="")
paste(paste("results",seed,iteration,K,n_mean,n_sd,n_target,moderators,
eps_study_m,eps_study_tau,distribution,target_dist,sep = "_"),
".Rdata",sep="")
paste(paste("results",seed,iteration,K,n_mean,n_sd,n_target,"modset",moderators,
eps_study_m,eps_study_tau,distribution,target_dist,sep = "_"),
".Rdata",sep="")
covars <- list(list(covars_fix="age", covars_rand="age",
eps_study_tau=0.05, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=0.5, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=1, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=0.5, eps_study_inter=0.5),
list(covars_fix="age", covars_rand="age",
eps_study_tau=1, eps_study_inter=1),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.05, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.5, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.5, eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.05, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.5, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.5, eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.05, eps_study_inter=0.05),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.5, eps_study_inter=0.05),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.5, eps_study_inter=0.5))
length(covars)
settings <- expand.grid(moderators = c(1:length(covars)),
eps_study_m = c(0.05, 1),
distribution = c("same", "varying_madrs", "halfdiff_madrsage", "separate_age"),
target_dist = c("same", "different"),
iteration = c(1:100))
nrow(settings)/100
covars <- list(list(covars_fix="age", covars_rand="age",
eps_study_tau=0.05, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=0.5, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=1, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=0.5, eps_study_inter=0.5),
list(covars_fix="age", covars_rand="age",
eps_study_tau=1, eps_study_inter=1),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.05, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.5, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.5, eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.05, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.5, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.5, eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.05, eps_study_inter=0.05),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.5, eps_study_inter=0.05),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.5, eps_study_inter=0.5))
settings <- expand.grid(moderators = c(1:length(covars)),
eps_study_m = c(0.05, 1),
distribution = c("same", "varying_madrs", "halfdiff_madrsage", "separate_age"),
target_dist = c("same", "different"),
iteration = c(1:100))
nrow(settings)
covars[[1]]
i=1
moderators <- settings$moderators[i]
covars_fix <- covars[[moderators]]$covars_fix
covars_rand <- covars[[moderators]]$covars_rand
eps_study_inter <- covars[[moderators]]$eps_study_inter
eps_study_m <- settings$eps_study_m[i]
eps_study_tau <- settings$eps_study_tau[i]
distribution <- settings$distribution[i]
target_dist <- settings$target_dist[i]
iteration <- settings$iteration[i]
seed <- i
covars_fix
covars_rand
eps_study_inter
moderators <- settings$moderators[i]
covars_fix <- covars[[moderators]]$covars_fix
covars_rand <- covars[[moderators]]$covars_rand
eps_study_tau <- covars[[moderators]]$eps_study_tau
eps_study_inter <- covars[[moderators]]$eps_study_inter
eps_study-tau
eps_study_tau
eps_study_inter
eps_study_m
distribution
target_dis
target_dist
iteration
seed
moderators
source("R/MDD_Generation_OOSEst.R")
source("R/MA_OOSEst.R")
# set up parameters
K <- 10
n_mean <- 500
n_sd <- 0
n_target <- 100
covars <- list(list(covars_fix="age", covars_rand="age",
eps_study_tau=0.05, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=0.5, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=1, eps_study_inter=0.05),
list(covars_fix="age", covars_rand="age",
eps_study_tau=0.5, eps_study_inter=0.5),
list(covars_fix="age", covars_rand="age",
eps_study_tau=1, eps_study_inter=1),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.05, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.5, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "madrs"), covars_rand=c("age", "madrs"),
eps_study_tau=0.5, eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.05, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.5, eps_study_inter=c(0.05,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age", "sex"),
eps_study_tau=0.5, eps_study_inter=c(0.5,0.05)),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.05, eps_study_inter=0.05),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.5, eps_study_inter=0.05),
list(covars_fix=c("age", "sex"), covars_rand=c("age"),
eps_study_tau=0.5, eps_study_inter=0.5))
settings <- expand.grid(moderators = c(1:length(covars)),
eps_study_m = c(0.05, 1),
distribution = c("same", "varying_madrs", "halfdiff_madrsage", "separate_age"),
target_dist = c("same", "different"),
iteration = c(1:100))
i=1
moderators <- settings$moderators[i]
covars_fix <- covars[[moderators]]$covars_fix
covars_rand <- covars[[moderators]]$covars_rand
eps_study_tau <- covars[[moderators]]$eps_study_tau
eps_study_inter <- covars[[moderators]]$eps_study_inter
eps_study_m <- settings$eps_study_m[i]
distribution <- settings$distribution[i]
target_dist <- settings$target_dist[i]
iteration <- settings$iteration[i]
seed <- i
#now code
set.seed(seed)
results <- compare_oos(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target, covars_fix=covars_fix,
covars_rand=covars_rand, eps_study_m=eps_study_m, eps_study_tau=eps_study_tau,
eps_study_inter=eps_study_inter, distribution=distribution, target_dist=target_dist)
## Simulate training and target (OOS) data
sim_dat <- gen_mdd(K, n_mean, n_sd, n_target, covars_fix, covars_rand,
eps_study_m, eps_study_tau, eps_study_inter,
distribution, target_dist)
train_dat <- sim_dat[["train_dat"]]
target_dat <- sim_dat[["target_dat"]]
## Fit mixed effects models
#correct
formula <- as.formula(paste0("Y ~ madrs + sex + age + W + ",
paste("W", covars_fix, sep=":", collapse=" + "),
" + (W + ",
paste("W", covars_rand, sep=":", collapse=" + "),
" | S)"))
mod <- lmer(formula, data=train_dat,
control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=10000)))
sum <- summary(mod)
#incorrect
formula_wrong <- as.formula(paste0("Y ~ madrs + sex + age + W + ",
paste("W", covars_fix, sep=":", collapse=" + "),
" + (W | S)"))
mod_wrong <- lmer(formula_wrong, data=train_dat,
control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=10000)))
sum_wrong <- summary(mod_wrong)
sum
## Calculate mean and CIs for individuals and assess accuracy
#confidence interval
glht_train <- glht_ci(train_dat, mod)
formula
source("R/MDD_Generation_OOSEst.R")
source("R/MA_OOSEst.R")
results <- compare_oos(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target, covars_fix=covars_fix,
covars_rand=covars_rand, eps_study_m=eps_study_m, eps_study_tau=eps_study_tau,
eps_study_inter=eps_study_inter, distribution=distribution, target_dist=target_dist)
## Save results
#data frame of parameters
params <- data.frame(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target,
covars_fix=covars_fix, covars_rand=covars_rand,
eps_study_m=eps_study_m,
eps_study_tau=eps_study_tau, eps_study_inter=eps_study_inter,
distribution=distribution, target_dist=target_dist)
params
covars_fix <- c("age","madrs")
## Save results
#data frame of parameters
params <- data.frame(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target,
covars_fix=covars_fix, covars_rand=covars_rand,
eps_study_m=eps_study_m,
eps_study_tau=eps_study_tau, eps_study_inter=eps_study_inter,
distribution=distribution, target_dist=target_dist)
params
paste(covars_fix, collapse = ", ")
paste(covars_rand, collapse = ", ")
source("R/MDD_Generation_OOSEst.R")
source("R/MA_OOSEst.R")
results <- compare_oos(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target, covars_fix=covars_fix,
covars_rand=covars_rand, eps_study_m=eps_study_m, eps_study_tau=eps_study_tau,
eps_study_inter=eps_study_inter, distribution=distribution, target_dist=target_dist)
covars_fix <- "age"
results <- compare_oos(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target, covars_fix=covars_fix,
covars_rand=covars_rand, eps_study_m=eps_study_m, eps_study_tau=eps_study_tau,
eps_study_inter=eps_study_inter, distribution=distribution, target_dist=target_dist)
results
i=2
moderators <- settings$moderators[i]
moderators
i=10
moderators <- settings$moderators[i]
moderators
covars_fix <- covars[[moderators]]$covars_fix
covars_rand <- covars[[moderators]]$covars_rand
eps_study_tau <- covars[[moderators]]$eps_study_tau
eps_study_inter <- covars[[moderators]]$eps_study_inter
eps_study_m <- settings$eps_study_m[i]
distribution <- settings$distribution[i]
target_dist <- settings$target_dist[i]
iteration <- settings$iteration[i]
seed <- i
seed
covars_fix
covars_rand
eps_study_tau
eps_study_inter
results <- compare_oos(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target, covars_fix=covars_fix,
covars_rand=covars_rand, eps_study_m=eps_study_m, eps_study_tau=eps_study_tau,
eps_study_inter=eps_study_inter, distribution=distribution, target_dist=target_dist)
covars_fix == c("age", "sex")
covars_rand == c("age", "sex")
length(covars_fix) == 1
covars_fix[2] == "madrs"
covars_fix[2] == "sex"
length(covars_fix) == 2 & length(covars_rand) == 2
length(covars_fix) == 2 & length(covars_rand ==1)
length(covars_fix) == 2 & length(covars_rand) == 1
source("R/MDD_Generation_OOSEst.R")
source("R/MA_OOSEst.R")
results <- compare_oos(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target, covars_fix=covars_fix,
covars_rand=covars_rand, eps_study_m=eps_study_m, eps_study_tau=eps_study_tau,
eps_study_inter=eps_study_inter, distribution=distribution, target_dist=target_dist)
covars_fix
covars_rand
#training data
train_dat <- data.frame()
n_study <- floor(rnorm(K, mean=n_mean, sd=n_sd))
#define covariance matrix
Sigma <- data.frame(age=c(165.6471, 0.2448, -0.5180, 1.6408, -0.9666),
sex=c(0.2448, 0.2183, -0.0218, -1.9030, 0.1380),
smstat=c(-0.5180, -0.0218, 0.2118, -0.1429, 0.1155),
weight=c(1.6408, -1.9030, -0.1428, 452.6100, -7.6864),
madrs=c(-0.9666, 0.1380, 0.1155, -7.6864, 17.5343),
row.names=c("age","sex","smstat","weight","madrs"))
for (k in 1:K) {
n <- n_study[k]
#sample
dat <- sample_dist(K, k, n, Sigma, eps_study_m, eps_study_tau, eps_study_inter, distribution)
train_dat <- bind_rows(train_dat, dat)
}
#target data
if (target_dist == "same") {
target_dat <- train_dat[sample(nrow(train_dat), n_target),] %>%
dplyr::select(-S, -contains("eps_"))
} else if (target_dist == "upweight") {
train_weight <- train_dat %>%
mutate(study_weight = ifelse(S %in% c(3, 5), 3, 1))
target_dat <- train_weight[sample(nrow(train_weight), n_target, prob=train_weight$study_weight),] %>%
dplyr::select(-study_weight, -S, -contains("eps_"))
} else if (target_dist == "different") {
target_mean <- c(age=30, sex=0.6784, smstat=0.3043, weight=79.0253, madrs=25)
target_dat <- MASS::mvrnorm(n=n_target, mu=target_mean, Sigma=Sigma) %>%
as.data.frame() %>%
mutate(sex = ifelse(sex > 1-0.6784, 1, 0),
smstat = ifelse(smstat > 1-0.3043, 1, 0),
eps = rnorm(n=n_target, mean=0, sd=.05),
W = rbinom(n=n_target, size=1, prob=.5))
}
head(train_dat)
head(target_dat)
#define random slopes for moderators in target sample
eps_inter_target <- matrix(nrow=n_target, ncol=length(covars_rand))
colnames(eps_inter_target) <- paste0("eps_",covars_rand)
for (i in 1:length(covars_rand)) {
eps_inter_target[,i] <- rnorm(n=n_target, mean=0, sd=eps_study_inter[i])
}
head(target_dat)
#add error terms to target sample
target_dat <- target_dat %>%
mutate(eps_m = rnorm(n=n_target, mean=0, sd=eps_study_m),
eps_tau = rnorm(n=n_target, mean=0, sd=eps_study_tau)) %>%
bind_cols(eps_inter_target)
head(target_dat)
#standardize variables
train_dat <- train_dat %>%
mutate(age = (age - mean(age))/sd(age),
madrs = (madrs - mean(madrs))/sd(madrs),
weight = (weight - mean(weight))/sd(weight))
target_dat <- target_dat %>%
mutate(age = (age - mean(age))/sd(age),
madrs = (madrs - mean(madrs))/sd(madrs),
weight = (weight - mean(weight))/sd(weight))
#add m and tau
if (length(covars_fix) == 1 & length(covars_rand) == 1) {
train_dat <- train_dat %>%
mutate(m = (-17.40 + eps_m) - 0.13*age - 2.05*madrs - 0.11*sex,
tau = (2.505 + eps_tau) + (0.82 + eps_age)*age)
target_dat <- target_dat %>%
mutate(m = (-17.40 + eps_m) - 0.13*age - 2.05*madrs - 0.11*sex,
tau = (2.505 + eps_tau) + (0.82 + eps_age)*age)
} else if (length(covars_fix) == 2 & length(covars_rand) == 2) {
if (covars_fix[2] == "madrs") {
train_dat <- train_dat %>%
mutate(m = (-17.29 + eps_m) - 0.20*age - 2.63*madrs - 0.14*sex,
tau = (2.506 + eps_tau) + (0.91 + eps_age)*age  (0.84 + eps_madrs)*madrs)
target_dat <- target_dat %>%
mutate(m = (-17.29 + eps_m) - 0.20*age - 2.63*madrs - 0.14*sex,
tau = (2.506 + eps_tau) + (0.91 + eps_age)*age  (0.84 + eps_madrs)*madrs)
} else if (covars_fix[2] == "sex") {
train_dat <- train_dat %>%
mutate(m = (-17.24 + eps_m) - 0.21*age - 2.03*madrs - 0.38*sex,
tau = (2.32 + eps_tau) + (0.88 + eps_age)*age  (0.36 + eps_sex)*sex)
target_dat <- target_dat %>%
mutate(m = (-17.24 + eps_m) - 0.21*age - 2.03*madrs - 0.38*sex,
tau = (2.32 + eps_tau) + (0.88 + eps_age)*age  (0.36 + eps_sex)*sex)
}
} else if (length(covars_fix) == 2 & length(covars_rand) == 1) {
train_dat <- train_dat %>%
mutate(m = (-17.18 + eps_m) - 0.12*age - 2.05*madrs - 0.42*sex,
tau = (2.20 + eps_tau) + (0.81 + eps_age)*age  (0.44)*sex)
target_dat <- target_dat %>%
mutate(m = (-17.18 + eps_m) - 0.12*age - 2.05*madrs - 0.42*sex,
tau = (2.20 + eps_tau) + (0.81 + eps_age)*age  (0.44)*sex)
}
train_dat <- train_dat %>%
mutate(m = (-17.24 + eps_m) - 0.21*age - 2.03*madrs - 0.38*sex,
tau = (2.32 + eps_tau) + (0.88 + eps_age)*age  (0.36 + eps_sex)*sex)
head(train_dat)
source("R/MDD_Generation_OOSEst.R")
source("R/MA_OOSEst.R")
results <- compare_oos(K=K, n_mean=n_mean, n_sd=n_sd, n_target=n_target, covars_fix=covars_fix,
covars_rand=covars_rand, eps_study_m=eps_study_m, eps_study_tau=eps_study_tau,
eps_study_inter=eps_study_inter, distribution=distribution, target_dist=target_dist)
results
