vartheta <- fc["W","W"] + x^2*fc["W:age","W:age"] +
2*x*fc["W","W:age"] + rc[which(rc$var1=="W" & is.na(rc$var2)==T),"vcov"] +
x^2*rc[which(rc$var1=="W:age" & is.na(rc$var2)==T),"vcov"] +
2*x*rc[which(rc$var1=="W" & rc$var2=="W:age"),"vcov"]
vartheta_matrix <- xm %*% bm %*% t(xm) + xm %*% rm %*% t(xm)
vartheta
vartheta_matrix
head(train_dat)
X <- train_dat %>%
mutate(trt = 1) %>%
select(trt, age)
X <- train_dat %>%
mutate(trt = 1) %>%
dplyr::select(trt, age)
X
X %*% bm %*% t(X)
matrix(X)
as.matrix(X)
X <- train_dat %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix()
head(x)
head(X)
X %*% bm %*% t(X)
X %*% bm %*% t(X) -> c
View()
View(c)
c@x
diag()
diag(X)
head(X)
diag(c)
X %*% bm %*% t(X) %>% diag()
0.15939246
age <- train_dat$age[1]
xm <- matrix(c(1,age), nrow=1, dimnames=list("ind",c("W","W:age"))) #X
bm <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
xm %*% bm %*% t(xm)
x
x <- train_dat$age[1]
fc["W","W"] + x^2*fc["W:age","W:age"] +
2*x*fc["W","W:age"]
X %*% bm %*% t(X) + X %*% rm %*% t(X)
X %*% bm %*% t(X) + X %*% rm %*% t(X) %>% diag()
X %*% bm %*% t(X) + X %*% rm %*% t(X) -> c
c
dim(C)
dim(c)
diag(c)
vartheta_matrix <- xm %*% bm %*% t(xm) + xm %*% rm %*% t(xm)
vartheta_matrix
vcov_theta <- X %*% bm %*% t(X) + X %*% rm %*% t(X)
var_theta <- diag(vcov_theta)
View(var_theta)
var_theta
practice <- data.frame(vartheta = rep(0, nrow(train_dat)),
vartheta_matrix = rep(0, nrow(train_dat)))
for (i in 1:nrow(train_dat)) {
age <- train_dat$age[i]
meantheta <- fixef(mod)["W"] + fixef(mod)["W:age"]*age
vartheta <- fc["W","W"] + age^2*fc["W:age","W:age"] +
2*age*fc["W","W:age"] + rc[which(rc$var1=="W" & is.na(rc$var2)==T),"vcov"] +
age^2*rc[which(rc$var1=="W:age" & is.na(rc$var2)==T),"vcov"] +
2*age*rc[which(rc$var1=="W" & rc$var2=="W:age"),"vcov"]
practice[i, "vartheta"] <- vartheta
xm <- matrix(c(1,age), nrow=1, dimnames=list("ind",c("W","W:age"))) #X
bm <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
rcov <- rc[c(which(rc$var1=="W" & is.na(rc$var2)==T),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W:age" & is.na(rc$var2)==T)), "vcov"]
rm <- matrix(rcov, nrow=2, dimnames=list(c("W","W:age"),c("W","W:age")))
meantheta <- fixef(mod)["W"] + fixef(mod)["W:age"]*x
vartheta_matrix <- xm %*% bm %*% t(xm) + xm %*% rm %*% t(xm)
practice[i, "vartheta_matrix"] <- vartheta_matrix
}
View(practice)
sum(practice$vartheta==practice$vartheta_matrix)
sum(abs(practice$vartheta-practice$vartheta_matrix)<10e-5)
sum(abs(practice$vartheta-practice$vartheta_matrix)<10e-5)
nrow(practice)
practice <- cbind(practice, c)
practice <- cbind(practice, var_theta)
sum(abs(practice$vartheta-practice$var_theta)<10e-5)
sum(abs(practice$vartheta_matrix-practice$var_theta)<10e-5)
fixef(mod)
fixef(mod)[c("W","W:age")]
bm
meantheta <- t(ixef(mod)[c("W","W:age")])
t(fixef(mod)[c("W","W:age")])
meantheta <- matrix(fixef(mod)[c("W","W:age")], nrow=2)
meantheta
meantheta <- X %*% matrix(fixef(mod)[c("W","W:age")], nrow=2)
meantheta
fixef(mod)
a <- -2.082347937 + 0.072841263*train_dat$age
View(cbind(a, meantheta))
sum(abs(a-meantheta)<10e-5)
10e-5
sum(abs(practice$vartheta-practice$var_theta)<10e-5)
sum(abs(practice$vartheta-practice$var_theta)<10e-10)
sum(abs(a-meantheta)<10e-10)
sum(abs(a-meantheta)<10e-7)
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta)
#matrix calculation
beta <- matrix(fixef(mod)[c("W","W:age")], nrow=2) #beta-hat
var_beta <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
rand <- rc[c(which(rc$var1=="W" & is.na(rc$var2)==T),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W:age" & is.na(rc$var2)==T)), "vcov"] #can I clean this up??
var_rand <- matrix(rcov, nrow=2, dimnames=list(c("W","W:age"),c("W","W:age"))) #Var(ranef)
X <- train_dat %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix()
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta)
sum(var_theta = practice$var_theta)
sum(var_theta == practice$var_theta)
meantheta <- X %*% beta
meantheta
sum(abs(a-meantheta)<10e-10)
sum(abs(a-meantheta)<10e-7)
#prediction interval
pred_lower <- round(mean_theta + qt(.025, 4)*sqrt(vartheta),2)
pred_upper <- round(mean_theta - qt(.025, 4)*sqrt(vartheta),2)
mean_theta <- X %*% beta #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- round(mean_theta + qt(.025, 4)*sqrt(vartheta),2)
pred_upper <- round(mean_theta - qt(.025, 4)*sqrt(vartheta),2)
pred_lower
pred_upper
x
ci <- glht(mod, linfct=paste0("W +",x,"*W:age = 0"))
ci
mean <- coef(ci) %>% as.numeric()
sd <- sqrt(vcov(ci)[1,1])
lower <- mean - 1.96*sd %>% as.numeric()
upper <- mean + 1.96*sd %>% as.numeric()
mean
sd
lower
ypper
upper
confint(ci)
#prediction interval by glht ####
age_ci <- function(x, mod) {
ci <- glht(mod, linfct=paste0("W +",x,"*W:age = 0"))
mean <- coef(ci) %>% as.numeric()
sd <- sqrt(vcov(ci)[1,1])
lower <- mean - 1.96*sd %>% as.numeric()
upper <- mean + 1.96*sd %>% as.numeric()
return(c(lower=lower, mean=mean, upper=upper))
} #get ci based on x=age (as a character)
glht_ci <- function(df, mod) {
ages <- as.character(df$age)
cis <- map_dfr(.x=ages, .f=age_ci, mod=mod)
df <- df %>%
bind_cols(cis)
return(df)
} #add ci to dataset
glht(train_dat, mod) -> d
glht(x, mod) -> d
glht_ci(train_dat, mod) -> d
View(d)
x
53.674415
x <- 53.674415
ci <- glht(mod, linfct=paste0("W +",x,"*W:age = 0"))
confint(ci)
ci <- glht(mod, linfct=paste0("W +","46.921213","*W:age = 0"))
confint(ci)
matrix_var <- function(mod) {
#calculate variances
fc <- vcov(mod) #covariance matrix of fixed effects
rc <- as.data.frame(VarCorr(mod)) #variance and covariances of random effects
#matrix calculation
beta <- matrix(fixef(mod)[c("W","W:age")], nrow=2) #beta-hat
var_beta <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
rand <- rc[c(which(rc$var1=="W" & is.na(rc$var2)==T),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W:age" & is.na(rc$var2)==T)), "vcov"] #can I clean this up??
var_rand <- matrix(rcov, nrow=2, dimnames=list(c("W","W:age"),c("W","W:age"))) #Var(ranef)
return(c(beta=beta, var_beta=var_beta, var_rand=var_rand))
}
matrix_var <- function(mod) {
#calculate variances
fc <- vcov(mod) #covariance matrix of fixed effects
rc <- as.data.frame(VarCorr(mod)) #variance and covariances of random effects
#matrix calculation
beta <- matrix(fixef(mod)[c("W","W:age")], nrow=2) #beta-hat
var_beta <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
rand <- rc[c(which(rc$var1=="W" & is.na(rc$var2)==T),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W:age" & is.na(rc$var2)==T)), "vcov"] #can I clean this up??
var_rand <- matrix(rcov, nrow=2, dimnames=list(c("W","W:age"),c("W","W:age"))) #Var(ranef)
return(c(beta=beta, var_beta=var_beta, var_rand=var_rand))
}
manual_pi <- function(df, mod) {
#get variances
res <- matrix_var(mod)
beta <- res$beta
var_beta <- res$var_beta
var_rand <- res$var_rand
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
mean_theta <- X %*% beta #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- mean_theta + qt(.025, 4)*sqrt(vartheta)
pred_upper <- mean_theta - qt(.025, 4)*sqrt(vartheta)
df <- df %>%
mutate(lower = pred_lower,
mean = mean_theta,
upper = pred_upper)
return(df)
}
res <- matrix(var(mod))
res <- matrix_var(mod))
res <- matrix_var(mod)
rs
res
matrix_var <- function(mod) {
#calculate variances
fc <- vcov(mod) #covariance matrix of fixed effects
rc <- as.data.frame(VarCorr(mod)) #variance and covariances of random effects
#matrix calculation
beta <- matrix(fixef(mod)[c("W","W:age")], nrow=2) #beta-hat
var_beta <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
rand <- rc[c(which(rc$var1=="W" & is.na(rc$var2)==T),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W:age" & is.na(rc$var2)==T)), "vcov"] #can I clean this up??
var_rand <- matrix(rcov, nrow=2, dimnames=list(c("W","W:age"),c("W","W:age"))) #Var(ranef)
return(list(beta=beta, var_beta=var_beta, var_rand=var_rand))
}
res <- matrix_var(mod)
res
res$beta
summary(mod)
vcov(mod)
1.384665^2
VarCorr(mod)
VarCorr(mod) %>% as.data.frame()
res$var_rand
manual_pi <- function(df, mod) {
#get variances
res <- matrix_var(mod)
beta <- res$beta
var_beta <- res$var_beta
var_rand <- res$var_rand
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
mean_theta <- X %*% beta #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- mean_theta + qt(.025, 4)*sqrt(vartheta)
pred_upper <- mean_theta - qt(.025, 4)*sqrt(vartheta)
df <- df %>%
mutate(lower = pred_lower,
mean = mean_theta,
upper = pred_upper)
return(df)
} #add pis to dataset
a <- manual_pi(train_dat, mod)
View(a)
#get variances
res <- matrix_var(mod)
beta <- res$beta
var_beta <- res$var_beta
var_rand <- res$var_rand
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
df <- train_dat
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
mean_theta <- X %*% beta #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
mean_theta
var_theta
head(mean_theta)
head(c(mean_theta))
mean_theta2 <- X %*% beta %>% c() #theta-hat
head(mean_theta)
head(mean_theta2)
all.equal(mean_theta, mean_theta2)
View(cbind(mean_theta, mean_theta2))
d <- cbind(mean_theta, mean_theta2)
sum(d$V1 == d$mean_theta2)
d <- data.frame(d)
head(d)
sum(d$V1==d$mean_theta2)
nrow(d)
nrow(train_dat)
mean_theta <- X %*% beta %>% c() #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- mean_theta + qt(.025, 4)*sqrt(vartheta)
pred_upper <- mean_theta - qt(.025, 4)*sqrt(vartheta)
pred_lower
manual_pi <- function(df, mod) {
#get variances
res <- matrix_var(mod)
beta <- res$beta
var_beta <- res$var_beta
var_rand <- res$var_rand
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
mean_theta <- X %*% beta %>% c() #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- mean_theta + qt(.025, 4)*sqrt(vartheta)
pred_upper <- mean_theta - qt(.025, 4)*sqrt(vartheta)
df <- df %>%
mutate(lower = pred_lower,
mean = mean_theta,
upper = pred_upper)
return(df)
} #add pis to dataset
d <- manual_pi(train_dat,mod)
View(d)
x <- 53.674415
meantheta <- fixef(mod)["W"] + fixef(mod)["W:age"]*x
vartheta <- fc["W","W"] + x^2*fc["W:age","W:age"] +
2*x*fc["W","W:age"] + rc[which(rc$var1=="W" & is.na(rc$var2)==T),"vcov"] +
x^2*rc[which(rc$var1=="W:age" & is.na(rc$var2)==T),"vcov"] +
2*x*rc[which(rc$var1=="W" & rc$var2=="W:age"),"vcov"]
meantheta
meantheta-qt(.025, 4)*sqrt(vartheta)
meantheta+qt(.025, 4)*sqrt(vartheta)
manual_pi <- function(df, mod, K) {
#get variances
res <- matrix_var(mod)
beta <- res$beta
var_beta <- res$var_beta
var_rand <- res$var_rand
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
mean_theta <- X %*% beta %>% c() #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- mean_theta + qt(.025, K-2)*sqrt(var_theta)
pred_upper <- mean_theta - qt(.025, K-2)*sqrt(var_theta)
df <- df %>%
mutate(lower = pred_lower,
mean = mean_theta,
upper = pred_upper)
return(df)
} #add pis to dataset
d <- manual_pi(train_dat,mod,6)
x=61.720146
meantheta <- fixef(mod)["W"] + fixef(mod)["W:age"]*x
vartheta <- fc["W","W"] + x^2*fc["W:age","W:age"] +
2*x*fc["W","W:age"] + rc[which(rc$var1=="W" & is.na(rc$var2)==T),"vcov"] +
x^2*rc[which(rc$var1=="W:age" & is.na(rc$var2)==T),"vcov"] +
2*x*rc[which(rc$var1=="W" & rc$var2=="W:age"),"vcov"]
meantheta
meantheta + qt(.025, 6-2)*sqrt(vartheta)
meantheta - qt(.025, 6-2)*sqrt(vartheta)
source("R/MDD_Generation_OOSEst.R")
#simulate data ####
sim_dat <- gen_mdd(K=6, n_mean=200, n_sd=0, eps_study_m=1, eps_study_tau=0.05,
distribution="same", target_dist="same")
train_dat <- sim_dat[["train_dat"]]
target_dat <- sim_dat[["target_dat"]]
covars <- c("sex", "smstat", "weight", "age", "madrs")
#model ####
mod <- lmer(Y ~ W + age + W:age +
(W + age + W:age | S), data=train_dat)
sum <- summary(mod)
sum
# PI calculation by hand ####
matrix_var <- function(mod) {
#calculate variances
fc <- vcov(mod) #covariance matrix of fixed effects
rc <- as.data.frame(VarCorr(mod)) #variance and covariances of random effects
#matrix calculation
beta <- matrix(fixef(mod)[c("W","W:age")], nrow=2) #beta-hat
var_beta <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
rand <- rc[c(which(rc$var1=="W" & is.na(rc$var2)==T),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W:age" & is.na(rc$var2)==T)), "vcov"] #can I clean this up??
var_rand <- matrix(rcov, nrow=2, dimnames=list(c("W","W:age"),c("W","W:age"))) #Var(ranef)
return(list(beta=beta, var_beta=var_beta, var_rand=var_rand))
} #get variance components of model
manual_pi <- function(df, mod, K) {
#get variances
res <- matrix_var(mod)
beta <- res$beta
var_beta <- res$var_beta
var_rand <- res$var_rand
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
mean_theta <- X %*% beta %>% c() #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- mean_theta + qt(.025, K-2)*sqrt(var_theta)
pred_upper <- mean_theta - qt(.025, K-2)*sqrt(var_theta)
df <- df %>%
mutate(lower = pred_lower,
mean = mean_theta,
upper = pred_upper)
return(df)
} #add pis to dataset
#prediction interval by glht ####
age_ci <- function(x, mod) {
ci <- glht(mod, linfct=paste0("W +",x,"*W:age = 0"))
mean <- coef(ci) %>% as.numeric()
sd <- sqrt(vcov(ci)[1,1])
lower <- mean - 1.96*sd %>% as.numeric()
upper <- mean + 1.96*sd %>% as.numeric()
return(c(lower=lower, mean=mean, upper=upper))
} #get ci based on x=age (as a character)
glht_ci <- function(df, mod) {
ages <- as.character(df$age)
cis <- map_dfr(.x=ages, .f=age_ci, mod=mod)
df <- df %>%
bind_cols(cis)
return(df)
} #add cis to dataset
a <- manual_pi(train_dat,mod,6)
# PI calculation by hand ####
matrix_var <- function(mod) {
#calculate variances
fc <- vcov(mod) #covariance matrix of fixed effects
rc <- as.data.frame(VarCorr(mod)) #variance and covariances of random effects
#matrix calculation
beta <- matrix(fixef(mod)[c("W","W:age")], nrow=2) #beta-hat
var_beta <- fc[c("W","W:age"),c("W","W:age")] #Var(beta-hat)
rand <- rc[c(which(rc$var1=="W" & is.na(rc$var2)==T),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W" & rc$var2=="W:age"),
which(rc$var1=="W:age" & is.na(rc$var2)==T)), "vcov"] #can I clean this up??
var_rand <- matrix(rand, nrow=2, dimnames=list(c("W","W:age"),c("W","W:age"))) #Var(ranef)
return(list(beta=beta, var_beta=var_beta, var_rand=var_rand))
} #get variance components of model
manual_pi <- function(df, mod, K) {
#get variances
res <- matrix_var(mod)
beta <- res$beta
var_beta <- res$var_beta
var_rand <- res$var_rand
#calculate theta-hats
X <- df %>%
mutate(trt = 1) %>%
dplyr::select(trt, age) %>%
as.matrix() #X (same as Z in this model)
mean_theta <- X %*% beta %>% c() #theta-hat
vcov_theta <- X %*% var_beta %*% t(X) + X %*% var_rand %*% t(X)
var_theta <- diag(vcov_theta) #Var(theta-hat)
#prediction interval
pred_lower <- mean_theta + qt(.025, K-2)*sqrt(var_theta)
pred_upper <- mean_theta - qt(.025, K-2)*sqrt(var_theta)
df <- df %>%
mutate(lower = pred_lower,
mean = mean_theta,
upper = pred_upper)
return(df)
} #add pis to dataset
a <- manual_pi(train_dat,mod,6)
View(a)
fixef(mod)["W"] + fixef(mod)["W:age"]*34.80091
x=34.8009134.80091
x=34.80091
fc <- vcov(mod)
rc <- as.data.frame(VarCorr(mod))
#example CATE PI ####
# example: let age be 40 years old
# x <- 40
# meantheta <- fixef(mod)["W"] + fixef(mod)["W:age"]*x
vartheta <- fc["W","W"] + x^2*fc["W:age","W:age"] +
2*x*fc["W","W:age"] + rc[which(rc$var1=="W" & is.na(rc$var2)==T),"vcov"] +
x^2*rc[which(rc$var1=="W:age" & is.na(rc$var2)==T),"vcov"] +
2*x*rc[which(rc$var1=="W" & rc$var2=="W:age"),"vcov"]
0.3755929 + qt(.025, 4)*sqrt(vartheta)
0.3755929 - qt(.025, 4)*sqrt(vartheta)
