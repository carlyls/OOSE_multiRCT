---
title: 'Estimating Confidence Intervals for CATE in Target Sample: Simulation Results'
author: "Carly Lupton Brantner"
date: '2023-04-07'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Combining Simulation Results

```{r}
library(tidyverse)

#read in all files
setwd("~/Desktop/Cluster/OOSEst")
files <- list.files(pattern=".Rdata")

# mylist <- lapply(files, function(x) {
#     load(file = x)
#     get(ls()[ls()!= "filename"])
#   })

all <- c()
for (i in 1:length(files)) {
  load(file = files[i])
  all <- bind_rows(all, results$all_res)
  print(i)
}

# get_res <- function(x) {return(x$all_res)}
# 
# all <- map_dfr(.x=mylist, .f=get_res)

#checking output
seeds <- strsplit(files,"_") %>% map_chr(.f=function(x) x[2])
length(unique(seeds)) == length(files) #making sure every iteration has a unique seed

nrow(all) #to make sure every iteration ran
#saveRDS(all, "all_results_11Apr2023.RDS", "~/Dropbox/Moderation/Out of Sample Prediction")
```

```{r}
mean_sd <- function(x) {
  return(paste(mean(x), sd(x), sep=" "))
}
#average across iterations
all_avg <- all %>%
  group_by(Metric, K, n_mean, n_sd, n_target, eps_study_m,
           eps_study_tau, eps_study_age, distribution, target_dist) %>%
  summarise(across(glht_res:boot_res_wrong, ~ mean_sd(.x)))

#long format for plotting
all_long <- all_avg %>%
  pivot_longer(cols=glht_res:boot_res_wrong,
               names_to="Method",
               values_to="Value") %>%
  separate(Value, into=c("Mean", "SD"), sep=" ") %>%
  mutate_at(c("Mean", "SD"), as.numeric) %>%
  mutate(eps = factor(paste(eps_study_tau, eps_study_age, sep="_")),
         eps_study_m = factor(eps_study_m),
         spec = ifelse(grepl("wrong", Method)==T, "Incorrectly Specified", "Correctly Specified"),
         model = ifelse(grepl("glht", Method)==T, "GLHT",
                        ifelse(grepl("manual", Method)==T, "Manual", "Boot")))
```

```{r}
#plot target coverage
#same target dist
all_long %>%
  filter(Metric == "target_coverage",
         target_dist == "same") %>%
  ggplot(aes(x=eps, y=Mean, group=Method, color=spec)) +
  geom_jitter(aes(shape=model), size=2.5, width=.2, height=0) +
  facet_grid(distribution~eps_study_m, scales='free') +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Variability of Trt and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample")

#different target dist
all_long %>%
  filter(Metric == "target_coverage",
         target_dist == "different") %>%
  ggplot(aes(x=eps, y=Mean, group=Method, color=spec)) +
  geom_jitter(aes(shape=model), size=2.5, width=.2, height=0) +
  facet_grid(distribution~eps_study_m, scales='free') +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Variability of Trt and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample")
```

```{r}
#removing GLHT
#same target dist
all_long %>%
  filter(Metric == "target_coverage",
         target_dist == "same",
         model != "glht") %>%
  ggplot(aes(x=eps, y=Mean, group=Method, color=spec)) +
  geom_jitter(aes(shape=model), size=2.5, width=.2, height=0) +
  facet_grid(distribution~eps_study_m, scales='free') +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Variability of Trt and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample")

#different target dist
all_long %>%
  filter(Metric == "target_coverage",
         target_dist == "different",
         model != "glht") %>%
  ggplot(aes(x=eps, y=Mean, group=Method, color=spec)) +
  geom_jitter(aes(shape=model), size=2.5, width=.2, height=0) +
  facet_grid(distribution~eps_study_m, scales='free') +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Variability of Trt and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample")
```


```{r}
#plot target coverage
all_long %>%
  filter(Metric == "target_coverage") %>%
  group_by(Method, model, spec) %>%
  summarise(Mean=mean(Mean)) %>%
  ggplot(aes(x=model, y=Mean, group=1, color=spec)) +
  geom_point(size=5) +
  theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1),
        plot.margin=margin(10,10,10,30),
        text = element_text(size=15)) +
  labs(color="Single-Study Approach") +
  xlab("Aggregation Approach") +
  scale_y_continuous(labels = scales::percent)
```


