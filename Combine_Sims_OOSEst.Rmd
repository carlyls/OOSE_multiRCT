---
title: 'Estimating Confidence Intervals for CATE in Target Sample: Simulation Results'
author: "Carly Lupton Brantner"
date: '2023-09-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Combining Simulation Results

```{r, message=F}
library(tidyverse)
```

```{r, eval=F}
#read in all files
setwd("~/Desktop/Cluster/OOSEst/11Oct2023")
files <- list.files(pattern=".Rdata")

all <- c()
for (i in 1:length(files)) {
  load(file = files[i])
  all <- bind_rows(all, results[["all_res"]])
  print(i)
}

#checking output
seeds <- strsplit(files,"_") %>% map_chr(.f=function(x) x[2])
length(unique(seeds)) == length(files) #making sure every iteration has a unique seed

nrow(all) #to make sure every iteration ran
setwd("~/Dropbox/Moderation/Out of Sample Prediction/Data")
saveRDS(all, "all_results_11Oct2023.RDS")
```

```{r, message=F, warning=F}
all <- readRDS("Data/all_results_11Oct2023.RDS")

#long form for boxplot
all_long <- all %>%
  rename(MA = manual_res, MA_Inc = manual_res_wrong,
         HCF = cf_res, ACF = cf_a_res,
         SBART = sb_res, TBART = tb_res) %>%
  pivot_longer(cols = MA:TBART,
               names_to = "Method",
               values_to = "Value") %>%
  mutate(scenario = paste(covars_fix, covars_rand, lin, eps_study_m,
                          eps_study_tau, eps_study_inter, sep = "_"),
         sds = paste(eps_study_m, eps_study_tau, eps_study_inter, sep = "_"),
         Dataset = factor(ifelse(grepl("target", Metric) == T,
                                 "Target", "Training"),
                          levels = c("Training", "Target")),
         Linear = ifelse(lin == T, "Linear", "Non-Linear"))

#average across iterations
all_sum <- all %>%
  rename(MA = manual_res, MA_Inc = manual_res_wrong,
         HCF = cf_res, ACF = cf_a_res,
         SBART = sb_res, TBART = tb_res) %>%
  group_by(Metric, K, n_mean, n_sd, n_target, covars_fix, covars_rand,
           lin, eps_study_m, eps_study_tau, eps_study_inter,
           distribution, target_dist) %>%
  summarise(across(MA:TBART, list(mean = mean, sd = sd)),
            n_iter = n())
summary(all_sum$n_iter) #check iterations

#average in long form
all_avg_long <- all %>%
  rename(MA = manual_res, MA_Inc = manual_res_wrong,
         HCF = cf_res, ACF = cf_a_res,
         SBART = sb_res, TBART = tb_res) %>%
  group_by(Metric, K, n_mean, n_sd, n_target, covars_fix, covars_rand,
           lin, eps_study_m, eps_study_tau, eps_study_inter,
           distribution, target_dist) %>%
  summarise(across(MA:TBART, mean)) %>%
  pivot_longer(cols = MA:TBART,
               names_to = "Method",
               values_to = "Value") %>%
  mutate(scenario = paste(covars_fix, covars_rand, lin, eps_study_m,
                          eps_study_tau, eps_study_inter, sep = "_"),
         sds = paste(eps_study_m, eps_study_tau, eps_study_inter, sep = "_"))
```

## Age Moderator, Same Target Distribution, Same Training Distributions

### Target CI Coverage

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age",
         target_dist == "same", distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_wrap(~lin) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution")
```

```{r}
# points version
all_avg_long %>%
  filter(Metric == "target_coverage", covars_fix == "age",
         target_dist == "same", distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_point(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_wrap(~lin) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution")
```


### Training CI Coverage

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "train_coverage", covars_fix == "age",
         target_dist == "same", distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_wrap(~lin) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Training Sample") +
  ggtitle("Same Target Distribution")
```

### Target Bias

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_bias", covars_fix == "age",
         target_dist == "same", distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_wrap(~lin) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("Mean Absolute Bias in Target Sample") +
  ggtitle("Same Target Distribution")
```

### Training Bias

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "train_bias", covars_fix == "age",
         target_dist == "same", distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_wrap(~lin) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("Mean Absolute Bias in Training Sample") +
  ggtitle("Same Target Distribution")
```

### Target CI Length

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_length", covars_fix == "age",
         target_dist == "same", distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_wrap(~lin) + ylim(0,10) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Length in Target Sample") +
  ggtitle("Same Target Distribution")
```

## Target CI Coverage

```{r, fig.height=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age",
         target_dist == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution")
```

```{r}
#age, different target distribution
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age",
         target_dist == "different") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Different Target Distribution")
```

```{r}
#age2, same target distribution
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age2, sex",
         target_dist == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution, Age2")
```

```{r, eval=F}
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age, madrs",
         target_dist == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution, Age and MADRS")
```


## Training CI Coverage

```{r}
#age, same target distribution
all_long %>%
  filter(Metric == "train_coverage", covars_fix == "age",
         target_dist == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Training Sample") +
  ggtitle("Same Target Distribution")
```


## Results by Method

For now, just using the setup where age is the fixed and random moderator, the training distributions are the same across trials, and the target distribution is the same as the training.

### Meta-Analysis

```{r, fig.height=7, fig.width=10}
#age, same target distribution
#mse
all_long %>%
  filter(Method %in% c("MA","MA_Inc"), covars_fix == "age",
         target_dist == "same", distribution == "same",
         grepl("mse", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_grid(Dataset~Linear, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("MSE")
ggsave("Results/19Oct2023/MA_MSE_19Oct2023.jpeg")

#coverage
all_long %>%
  filter(Method %in% c("MA","MA_Inc"), covars_fix == "age",
         target_dist == "same", distribution == "same",
         grepl("coverage", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(Dataset~Linear, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent") 
ggsave("Results/19Oct2023/MA_Cov_19Oct2023.jpeg")
```

### Causal Forest

```{r, fig.height=7, fig.width=10}
#age, same target distribution
#mse
all_long %>%
  filter(Method %in% c("HCF","ACF"), covars_fix == "age",
         target_dist == "same", distribution == "same",
         grepl("mse", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_grid(Dataset~Linear, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("MSE")
ggsave("Results/19Oct2023/CF_MSE_19Oct2023.jpeg")

#coverage
all_long %>%
  filter(Method %in% c("HCF","ACF"), covars_fix == "age",
         target_dist == "same", distribution == "same",
         grepl("coverage", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(Dataset~Linear, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent") 
ggsave("Results/19Oct2023/CF_Cov_19Oct2023.jpeg")
```

### BART

```{r, fig.height=7, fig.width=10}
#age, same target distribution
#mse
all_long %>%
  filter(Method %in% c("SBART","TBART"), covars_fix == "age",
         target_dist == "same", distribution == "same",
         grepl("mse", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_grid(Dataset~Linear, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("MSE")
ggsave("Results/19Oct2023/BART_MSE_19Oct2023.jpeg")

#coverage
all_long %>%
  filter(Method %in% c("SBART","TBART"), covars_fix == "age",
         target_dist == "same", distribution == "same",
         grepl("coverage", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(Dataset~Linear, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent") 
ggsave("Results/19Oct2023/BART_Cov_19Oct2023.jpeg")
```


