---
title: 'Estimating Confidence Intervals for CATE in Target Sample: Simulation Results'
author: "Carly Lupton Brantner"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Combining Simulation Results

```{r, message=F}
library(tidyverse)
```

```{r, eval=F}
#read in all files
setwd("~/Desktop/Cluster/OOSEst/26Oct2023")
files <- list.files(pattern=".Rdata")

all_res <- target_res <- c()
for (i in 1:length(files)) {
  load(file = files[i])
  
  #all metrics
  all_res_ind <- results$all_res
  all_res <- bind_rows(all_res, all_res_ind)
  
  #target metrics
  target_res_ind <- results$target_res %>%
    mutate(K = unique(all_res_ind$K),
           n_mean = unique(all_res_ind$n_mean),
           n_sd = unique(all_res_ind$n_sd),
           covars_fix = unique(all_res_ind$covars_fix),
           covars_rand = unique(all_res_ind$covars_rand),
           lin = unique(all_res_ind$lin),
           eps_study_m = unique(all_res_ind$eps_study_m),
           eps_study_tau = unique(all_res_ind$eps_study_tau),
           eps_study_inter = unique(all_res_ind$eps_study_inter),
           distribution = unique(all_res_ind$distribution))
  target_res <- bind_rows(target_res, target_res_ind)
  
  print(i)
}

#checking output
seeds <- strsplit(files,"_") %>% map_chr(.f=function(x) x[2])
length(unique(seeds)) == length(files) #making sure every iteration has a unique seed

nrow(all_res) #to make sure every iteration ran
nrow(target_res)/800
setwd("~/Dropbox/Moderation/Out of Sample Prediction/Data")
saveRDS(all_res, "all_res_26Oct2023.RDS")
saveRDS(target_res, "target_res_26Oct2023.RDS")
```

```{r, message=F, warning=F}
all_res <- readRDS("Data/all_res_26Oct2023.RDS")
target_res <- readRDS("Data/target_res_26Oct2023.RDS")

#summarise across iterations
target_ind <- target_res %>%
  group_by(id, W, sex, smstat, age, age2, weight, madrs, Y, tau, method,
           K, n_mean, n_sd, covars_fix, covars_rand, lin, eps_study_m,
           eps_study_tau, eps_study_inter, distribution) %>%
  summarise(n_iter = n(),
            coverage = mean(coverage),
            bias = mean(bias),
            abs_bias = mean(abs_bias),
            length = mean(length),
            significant = mean(significant)) %>%
  mutate(scenario = paste(covars_fix, covars_rand, lin, eps_study_m,
                          eps_study_tau, eps_study_inter, sep = "_"),
         sds = paste(eps_study_m, eps_study_tau, eps_study_inter, sep = "_"),
         Linear = ifelse(lin == T, "Linear", "Non-Linear"),
         sds_lab = factor(case_when(sds == "0.05_0.05_0.05" ~ "Low Heterogeneity",
                             sds == "1_0.05_0.05" ~ "Heterogeneous Intercept",
                             sds == "1_0.5_0.05" ~ "Heterogeneous Main",
                             sds == "1_1_0.5" ~ "High Heterogeneity"), 
                          levels = c("Low Heterogeneity", "Heterogeneous Intercept",
                                     "Heterogeneous Main", "High Heterogeneity")))

#average across target sample
target_sum <- target_ind %>%
  group_by(method,
           K, n_mean, n_sd, covars_fix, covars_rand, lin, eps_study_m,
           eps_study_tau, eps_study_inter, distribution) %>%
  summarise(across(coverage:significant, list(mean = mean, sd = sd))) %>%
  mutate(scenario = paste(covars_fix, covars_rand, lin, eps_study_m,
                          eps_study_tau, eps_study_inter, sep = "_"),
         sds = paste(eps_study_m, eps_study_tau, eps_study_inter, sep = "_"),
         Linear = ifelse(lin == T, "Linear", "Non-Linear"),
         sds_lab = factor(case_when(sds == "0.05_0.05_0.05" ~ "Low Heterogeneity",
                             sds == "1_0.05_0.05" ~ "Heterogeneous Intercept",
                             sds == "1_0.5_0.05" ~ "Heterogeneous Main",
                             sds == "1_1_0.5" ~ "High Heterogeneity"), 
                          levels = c("Low Heterogeneity", "Heterogeneous Intercept",
                                     "Heterogeneous Main", "High Heterogeneity")))

#long form for boxplot
all_long <- all_res %>%
  rename(MA = manual_res, MA_Inc = manual_res_wrong,
         HCF = cf_res, ACF = cf_a_res,
         HCF_Rand = cf_res_rand, ACF_Rand = cf_a_res_rand,
         SBART = sb_res, SBART_Rand = sb_res_rand) %>%
  pivot_longer(cols = MA:SBART_Rand,
               names_to = "Method",
               values_to = "Value") %>%
  mutate(scenario = paste(covars_fix, covars_rand, lin, eps_study_m,
                          eps_study_tau, eps_study_inter, sep = "_"),
         sds = paste(eps_study_m, eps_study_tau, eps_study_inter, sep = "_"),
         Dataset = factor(ifelse(grepl("target", Metric) == T,
                                 "Target", "Training"),
                          levels = c("Training", "Target")),
         Linear = ifelse(lin == T, "Linear", "Non-Linear"))

#average across iterations
all_sum <- all_res %>%
  rename(MA = manual_res, MA_Inc = manual_res_wrong,
         HCF = cf_res, ACF = cf_a_res,
         HCF_Rand = cf_res_rand, ACF_Rand = cf_a_res_rand,
         SBART = sb_res, SBART_Rand = sb_res_rand) %>%
  group_by(Metric, K, n_mean, n_sd, covars_fix, covars_rand,
           lin, eps_study_m, eps_study_tau, eps_study_inter,
           distribution) %>%
  summarise(across(MA:SBART_Rand, list(mean = mean, sd = sd)),
            n_iter = n())
summary(all_sum$n_iter) #check iterations

#average in long form
all_avg_long <- all_res %>%
  rename(MA = manual_res, MA_Inc = manual_res_wrong,
         HCF = cf_res, ACF = cf_a_res,
         HCF_Rand = cf_res_rand, ACF_Rand = cf_a_res_rand,
         SBART = sb_res, SBART_Rand = sb_res_rand) %>%
  group_by(Metric, K, n_mean, n_sd, covars_fix, covars_rand,
           lin, eps_study_m, eps_study_tau, eps_study_inter,
           distribution) %>%
  summarise(across(MA:SBART_Rand, mean)) %>%
  pivot_longer(cols = MA:SBART_Rand,
               names_to = "Method",
               values_to = "Value") %>%
  mutate(scenario = paste(covars_fix, covars_rand, lin, eps_study_m,
                          eps_study_tau, eps_study_inter, sep = "_"),
         sds = paste(eps_study_m, eps_study_tau, eps_study_inter, sep = "_"))
```

## TARGET EVAL: Age Moderator, Same Training Distribution

### Coverage

```{r, eval=F, fig.height=7, fig.width=10}
#boxplot across 100 people in target sample
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method)) +
  geom_boxplot(aes(y=coverage)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=15)) +
  ylab("Coverage in Target Sample") +
  xlab("")
#ggsave("Results/26Oct2023/coverage.jpeg")
```

```{r, eval=F}
#for job talk
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method %in% c("HCF", "MA", "SBART")) %>%
  mutate(method = factor(method, levels = c("MA", "HCF", "SBART"))) %>%
  ggplot(aes(x=method)) +
  geom_boxplot(aes(y=coverage)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample") +
  xlab("")
```


```{r, fig.height=7, fig.width=10}
#average across all iterations
target_sum %>%
  filter(covars_fix == "age",
         distribution == "same",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method)) +
  geom_point(aes(y=coverage_mean)) +
  # geom_errorbar(aes(ymin = coverage_mean - 1.96*coverage_sd,
  #                   ymax = min(coverage_mean + 1.96*coverage_sd, 1),
  #                   color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```

```{r}
#coverage by age - HCF
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method == "HCF") %>%
  ggplot(aes(x=age, y=coverage)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  ggtitle("Results Using HCF")
```

```{r}
#coverage by madrs - HCF
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method == "HCF") %>%
  ggplot(aes(x=madrs, y=coverage)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  ggtitle("Results Using HCF")
```

```{r}
#coverage by age - SBART
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method == "SBART") %>%
  ggplot(aes(x=age, y=coverage)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  ggtitle("Results Using SBART")
```

### Length

```{r, eval=F, fig.height=7, fig.width=10}
#boxplot across 100 people in target sample
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method)) +
  geom_boxplot(aes(y=length)) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Interval Length in Target Sample") +
  xlab("")
#ggsave("Results/26Oct2023/length.jpeg")
```

```{r, fig.height=7, fig.width=10}
#average across all iterations
target_sum %>%
  filter(covars_fix == "age",
         distribution == "same",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method)) +
  geom_point(aes(y=length_mean)) +
  # geom_errorbar(aes(ymin = coverage_mean - 1.96*coverage_sd,
  #                   ymax = min(coverage_mean + 1.96*coverage_sd, 1),
  #                   color=method)) +
  facet_grid(Linear ~ sds) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("CI Length in Target Sample")
```

```{r}
#length by age - HCF
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method == "HCF") %>%
  ggplot(aes(x=age, y=length)) +
  geom_point() +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  ggtitle("Results Using HCF")
```

### Bias

```{r, fig.height=7, fig.width=10}
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  mutate(sds_lab = factor(case_when(sds == "0.05_0.05_0.05" ~ "Low Heterogeneity",
                             sds == "1_0.05_0.05" ~ "Heterogeneous Intercept",
                             sds == "1_0.5_0.05" ~ "Heterogeneous Main",
                             sds == "1_1_0.5" ~ "High Heterogeneity"), 
                          levels = c("Low Heterogeneity", "Heterogeneous Intercept",
                                     "Heterogeneous Main", "High Heterogeneity"))) %>%
  ggplot(aes(x=method)) +
  geom_boxplot(aes(y=abs_bias)) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Absolute Bias in Target Sample") +
  xlab("")
ggsave("Results/26Oct2023/abs_bias.jpeg")
```

```{r}
#for job talk
target_ind %>%
  filter(covars_fix == "age",
         distribution == "same",
         method %in% c("HCF", "MA", "SBART")) %>%
  mutate(method = factor(method, levels = c("MA", "HCF", "SBART")),
         sds_lab = factor(case_when(sds == "0.05_0.05_0.05" ~ "Low Heterogeneity",
                             sds == "1_0.05_0.05" ~ "Heterogeneous Intercept",
                             sds == "1_0.5_0.05" ~ "Heterogeneous Main",
                             sds == "1_1_0.5" ~ "High Heterogeneity"), levels = c("Low Heterogeneity", "Heterogeneous Intercept", "Heterogeneous Main", "High Heterogeneity"))) %>%
  ggplot(aes(x=method)) +
  geom_boxplot(aes(y=abs_bias)) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=15)) +
  ylab("Absolute Bias in Target Sample") +
  xlab("")
```



## TARGET EVAL: Other Settings

### Age Moderator, Varying MADRS in Training Distributions

```{r, fig.height=7, fig.width=10}
#boxplot across 100 people in target sample
target_ind %>%
  filter(covars_fix == "age",
         distribution == "varying_madrs",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method, group=method)) +
  geom_boxplot(aes(y=coverage, color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```

```{r, fig.height=7, fig.width=10}
#average across all iterations
target_sum %>%
  filter(covars_fix == "age",
         distribution == "varying_madrs",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method)) +
  geom_point(aes(y=coverage_mean)) +
  # geom_errorbar(aes(ymin = coverage_mean - 1.96*coverage_sd,
  #                   ymax = min(coverage_mean + 1.96*coverage_sd, 1),
  #                   color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```

```{r}
#coverage by age - HCF
target_ind %>%
  filter(covars_fix == "age",
         distribution == "varying_madrs",
         method == "HCF") %>%
  ggplot(aes(x=age, y=coverage)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  ggtitle("Results Using HCF")
```

```{r}
#covarage by madrs - HCF
target_ind %>%
  filter(covars_fix == "age",
         distribution == "varying_madrs",
         method == "HCF") %>%
  ggplot(aes(x=madrs, y=coverage)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Linear ~ sds_lab, scales = "free") +
  ggtitle("Results Using HCF")
```



### Age Moderator, Varying Age in Training Distributions

```{r, fig.height=7, fig.width=10}
#boxplot across 100 people in target sample
target_ind %>%
  filter(covars_fix == "age",
         distribution == "separate_age",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method, group=method)) +
  geom_boxplot(aes(y=coverage, color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```


### Age and MADRS Moderator, Same Training Distributions

```{r, fig.height=7, fig.width=10}
#boxplot across 100 people in target sample
target_ind %>%
  filter(covars_fix == "age, madrs",
         distribution == "same",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method, group=method)) +
  geom_boxplot(aes(y=coverage, color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```

```{r, fig.height=7, fig.width=10}
#average across all iterations
target_sum %>%
  filter(covars_fix == "age, madrs",
         distribution == "same",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method)) +
  geom_point(aes(y=coverage_mean)) +
  # geom_errorbar(aes(ymin = coverage_mean - 1.96*coverage_sd,
  #                   ymax = min(coverage_mean + 1.96*coverage_sd, 1),
  #                   color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```

```{r}
#coverage by age - HCF
target_ind %>%
  filter(covars_fix == "age, madrs",
         distribution == "same",
         method == "HCF") %>%
  ggplot(aes(x=age, y=coverage)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Linear ~ sds, scales = "free") +
  ggtitle("Results Using HCF")
```

```{r}
#coverage by madrs - HCF
target_ind %>%
  filter(covars_fix == "age, madrs",
         distribution == "same",
         method == "HCF") %>%
  ggplot(aes(x=madrs, y=coverage)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Linear ~ sds, scales = "free") +
  ggtitle("Results Using HCF")
```


### Age and MADRS Moderator, Varying MADRS in Training Distributions

```{r, fig.height=7, fig.width=10}
#boxplot across 100 people in target sample
target_ind %>%
  filter(covars_fix == "age, madrs",
         distribution == "varying_madrs",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method, group=method)) +
  geom_boxplot(aes(y=coverage, color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```


### Age and MADRS Moderator, Separate Age in Training Distributions

```{r, fig.height=7, fig.width=10}
#boxplot across 100 people in target sample
target_ind %>%
  filter(covars_fix == "age, madrs",
         distribution == "separate_age",
         method %in% c("ACF", "HCF", "MA", "MA_Inc", "SBART")) %>%
  ggplot(aes(x=method, group=method)) +
  geom_boxplot(aes(y=coverage, color=method)) +
  geom_hline(aes(yintercept = 0.95), linetype = "dashed") +
  facet_grid(Linear ~ sds, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  ylab("Coverage in Target Sample")
```


## Results by Method

For now, just using the setup where age is the fixed and random moderator, the training distributions are the same across trials, and the target distribution is the same as the training.

### Meta-Analysis

```{r, fig.height=7, fig.width=10}
#age, same target distribution
#mse
all_long %>%
  filter(Method %in% c("MA","MA_Inc"), covars_fix == "age",
         distribution == "same",
         grepl("mse", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_grid(Dataset~Linear, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("MSE")
#ggsave("Results/19Oct2023/MA_MSE_19Oct2023.jpeg")

#coverage
all_long %>%
  filter(Method %in% c("MA","MA_Inc"), covars_fix == "age",
         distribution == "same",
         grepl("coverage", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(Dataset~Linear, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent") 
#ggsave("Results/19Oct2023/MA_Cov_19Oct2023.jpeg")
```

### Causal Forest

```{r, fig.height=7, fig.width=10}
#age, same target distribution
#mse
all_long %>%
  filter(Method %in% c("HCF","ACF","HCF_Rand","ACF_Rand"), covars_fix == "age",
         distribution == "same",
         grepl("mse", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_grid(Dataset~Linear, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("MSE")
#ggsave("Results/19Oct2023/CF_MSE_19Oct2023.jpeg")

#coverage
all_long %>%
  filter(Method %in% c("HCF","ACF","HCF_Rand","ACF_Rand"), covars_fix == "age",
         distribution == "same",
         grepl("coverage", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(Dataset~Linear, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent") 
#ggsave("Results/19Oct2023/CF_Cov_19Oct2023.jpeg")
```

### BART

```{r, fig.height=7, fig.width=10}
#age, same target distribution
#mse
all_long %>%
  filter(Method %in% c("SBART","SBART_Rand"), covars_fix == "age",
         distribution == "same",
         grepl("mse", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_grid(Dataset~Linear, scales = "free") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("MSE")
#ggsave("Results/19Oct2023/BART_MSE_19Oct2023.jpeg")

#coverage
all_long %>%
  filter(Method %in% c("SBART","SBART_Rand"), covars_fix == "age",
         distribution == "same",
         grepl("coverage", Metric) == T,
         sds != "1_1_0.5") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(Dataset~Linear, scales = "free") +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent") 
#ggsave("Results/19Oct2023/BART_Cov_19Oct2023.jpeg")
```


## Old


### Target CI Coverage

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age",
         distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_wrap(~lin) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution")
```

```{r}
# points version
all_avg_long %>%
  filter(Metric == "target_coverage", covars_fix == "age",
         distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_point(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_wrap(~lin) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution")
```


### Training CI Coverage

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "train_coverage", covars_fix == "age",
         distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_wrap(~lin) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Training Sample") +
  ggtitle("Same Target Distribution")
```

### Target Bias

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_bias", covars_fix == "age",
         distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_wrap(~lin) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("Mean Absolute Bias in Target Sample") +
  ggtitle("Same Target Distribution")
```

### Training Bias

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "train_bias", covars_fix == "age",
         distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_wrap(~lin) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("Mean Absolute Bias in Training Sample") +
  ggtitle("Same Target Distribution")
```

### Target CI Length

```{r, fig.height=7, fig.width=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_length", covars_fix == "age",
         distribution == "same") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  facet_wrap(~lin) + ylim(0,10) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Length in Target Sample") +
  ggtitle("Same Target Distribution")
```

## Target CI Coverage

```{r, fig.height=10}
#age, same target distribution
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution")
```



```{r}
all_long %>%
  filter(Metric == "target_coverage", covars_fix == "age, madrs") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Target Sample") +
  ggtitle("Same Target Distribution, Age and MADRS")
```


## Training CI Coverage

```{r}
#age, same target distribution
all_long %>%
  filter(Metric == "train_coverage", covars_fix == "age") %>%
  ggplot(aes(x=sds, y=Value)) +
  geom_boxplot(aes(color = Method)) +
  geom_hline(aes(yintercept=.95), linetype = "dashed") +
  facet_grid(lin~distribution) +
  scale_y_continuous(labels = scales::percent, limits = c(.75, 1)) +
  labs(color="Method") +
  theme(axis.text.x = element_text(angle=90),
        text = element_text(size=12)) +
  xlab("Variability of Main, Trt, and Trt*Age Coefficients") +
  ylab("CI Coverage Percent in Training Sample") +
  ggtitle("Same Target Distribution")
```


